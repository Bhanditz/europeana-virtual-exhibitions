# Image processing and serving

By default alchemy handles all image resizing inline during a request. This works if you would run the CMS on a server that has persistent storage. However since Europeana is running on anynines the disk cache is not persistent and thus can not be relied upon.

To fix this a caching layer using Swift was created, it works as follows:

1. A request for a specific image in a specific size comes in.
2. In the database it is checked or this version has already been generated in the past, see **Alchemy::PictureVersion**.
3. If that is the case based on the [signature](http://markevans.github.io/dragonfly/cache/) generated by Dragonfly the file will be retrieved from the datastore (Swift in this case).
4. If no version has been stored in the past, a new version will be generated and stored in the database.

To implement this a couple of small changes have been made to the *pictures_controller.rb*.

On top of that a background job has been setup that creates the most used versions of each image after uploading. New versions can be added in *Europeana::Mixins::ImageVersion::VERSIONS*

## Background job

All the image versions defined in *Europeana::Mixins::ImageVersion::VERSIONS* are generated when an image is uploaded. The job can be found in *Europeana::PictureVersionsJob*.
